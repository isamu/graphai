"use strict";var e=require("@graphai/step_runner_agent_filters"),t=require("@graphai/stream_agent_filters"),r=require("ajv"),n=require("graphai"),a=require("@noble/hashes/sha2");const s=(e,t,n,a)=>{if(!(new r).compile(e)(t))throw new Error(`${n}(${a??"func"}) schema not matched`);return!0};const o=async(e,t,r,n,a)=>{const s=async function*(e,t,r){const{params:n,namedInputs:a,debugInfo:s,filterParams:o}=t,i={params:n,debugInfo:s,filterParams:o,namedInputs:a},c={...r,"Content-Type":"text/event-stream"},u=await fetch(e,{headers:c,method:"POST",body:JSON.stringify(i)}),p=u.body?.getReader();if(200!==u.status||!p)throw new Error("Request failed");const d=new TextDecoder("utf-8");let l=!1;for(;!l;){const{done:e,value:t}=await p.read();if(e)l=e,p.releaseLock();else{const e=d.decode(t,{stream:!0});yield e}}}(t,r,n),o=[];for await(const t of s)a&&console.log(t),t&&(o.push(t),-1===o.join("").indexOf("___END___")&&e.filterParams.streamTokenCallback&&e.filterParams.streamTokenCallback(t));const i=o.join("").split("___END___")[1];return JSON.parse(i)},i=e=>Array.isArray(e)?e.map((e=>i(e))):n.isObject(e)?Object.keys(e).sort().reduce(((t,r)=>(t[r]=e[r],t)),{}):e,c=e=>{const{namedInputs:t,params:r,debugInfo:n}=e,{agentId:s}=n,o=a.sha256(JSON.stringify(i({namedInputs:t,params:r,agentId:s})));return btoa(String.fromCharCode(...o))};Object.defineProperty(exports,"consoleStepRunner",{enumerable:!0,get:function(){return e.consoleStepRunner}}),Object.defineProperty(exports,"stepRunnerGenerator",{enumerable:!0,get:function(){return e.stepRunnerGenerator}}),Object.defineProperty(exports,"streamAgentFilterGenerator",{enumerable:!0,get:function(){return t.streamAgentFilterGenerator}}),exports.agentFilterRunnerBuilder=e=>{const t=e;return(e,r)=>{let n=0;const a=e=>{const s=t[n++];return s?s.agent(e,a):r(e)};return a(e)}},exports.agentInputValidator=s,exports.cacheAgentFilterGenerator=e=>{const{getCache:t,setCache:r,getCacheKey:n}=e;return async(e,a)=>{if("pureAgent"===e.cacheType||void 0===e.cacheType){const s=n?n(e):c(e),o=await t(s);if(o)return o;const i=await a(e);return await r(s,i),i}return"impureAgent"===e.cacheType&&(e.filterParams.cache={getCache:t,setCache:r,getCacheKey:c}),a(e)}},exports.httpAgentFilter=async(e,t)=>{const{params:r,debugInfo:a,filterParams:s,namedInputs:i,config:c}=e;if(s?.server){const{baseUrl:t,isDebug:u,serverAgentUrlDictionary:p}=s.server,d=c?.headers??{};if(!n.isObject(d))throw new Error("httpAgentFilter: headers is not object.");const l=a.agentId,f=void 0!==s.streamTokenCallback,g=p&&l&&p[l]?p[l]:[t,l].join("/");void 0===g&&console.log("httpAgentFilter: Url is not defined");const m={params:r,debugInfo:a,filterParams:s,namedInputs:i,inputs:i};return f?await o(e,g,m,d,u):await(async(e,t,r)=>{const n={...r,"Content-Type":"application/json"},a=await fetch(e,{method:"post",headers:n,body:JSON.stringify(t)});return await a.json()})(g,m,d)}return t(e)},exports.namedInputValidatorFilter=async(e,t)=>{const{inputSchema:r,namedInputs:n}=e,{agentId:a,nodeId:o}=e.debugInfo;return r&&"array"!==r.type&&s(r,n||{},o,a),t(e)},exports.sortObjectKeys=i;
//# sourceMappingURL=bundle.cjs.js.map
