!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@graphai/step_runner_agent_filters"),require("@graphai/stream_agent_filters"),require("ajv"),require("graphai"),require("@noble/hashes/sha2")):"function"==typeof define&&define.amd?define(["exports","@graphai/step_runner_agent_filters","@graphai/stream_agent_filters","ajv","graphai","@noble/hashes/sha2"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).graphai_agent_filters={},e.step_runner_agent_filters,e.stream_agent_filters,e.Ajv,e.graphai,e.sha2)}(this,(function(e,t,r,a,n,s){"use strict";const o=(e,t,r,n)=>{if(!(new a).compile(e)(t))throw new Error(`${r}(${n??"func"}) schema not matched`);return!0};const i=async(e,t,r,a,n)=>{const s=async function*(e,t,r){const{params:a,namedInputs:n,debugInfo:s,filterParams:o}=t,i={params:a,debugInfo:s,filterParams:o,namedInputs:n},c={...r,"Content-Type":"text/event-stream"},u=await fetch(e,{headers:c,method:"POST",body:JSON.stringify(i)}),f=u.body?.getReader();if(200!==u.status||!f)throw new Error("Request failed");const d=new TextDecoder("utf-8");let l=!1;for(;!l;){const{done:e,value:t}=await f.read();if(e)l=e,f.releaseLock();else{const e=d.decode(t,{stream:!0});yield e}}}(t,r,a),o=[];for await(const t of s)n&&console.log(t),t&&(o.push(t),-1===o.join("").indexOf("___END___")&&e.filterParams.streamTokenCallback&&e.filterParams.streamTokenCallback(t));const i=o.join("").split("___END___")[1];return JSON.parse(i)},c=e=>Array.isArray(e)?e.map((e=>c(e))):n.isObject(e)?Object.keys(e).sort().reduce(((t,r)=>(t[r]=e[r],t)),{}):e,u=e=>{const{namedInputs:t,params:r,debugInfo:a}=e,{agentId:n}=a,o=s.sha256(JSON.stringify(c({namedInputs:t,params:r,agentId:n})));return btoa(String.fromCharCode(...o))};e.agentFilterRunnerBuilder=e=>{const t=e;return(e,r)=>{let a=0;const n=e=>{const s=t[a++];return s?s.agent(e,n):r(e)};return n(e)}},e.agentInputValidator=o,e.cacheAgentFilterGenerator=e=>{const{getCache:t,setCache:r,getCacheKey:a}=e;return async(e,n)=>{if("pureAgent"===e.cacheType||void 0===e.cacheType){const s=a?a(e):u(e),o=await t(s);if(o)return o;const i=await n(e);return await r(s,i),i}return"impureAgent"===e.cacheType&&(e.filterParams.cache={getCache:t,setCache:r,getCacheKey:u}),n(e)}},e.httpAgentFilter=async(e,t)=>{const{params:r,debugInfo:a,filterParams:s,namedInputs:o,config:c}=e;if(s?.server){const{baseUrl:t,isDebug:u,serverAgentUrlDictionary:f}=s.server,d=c?.headers??{};if(!n.isObject(d))throw new Error("httpAgentFilter: headers is not object.");const l=a.agentId,p=void 0!==s.streamTokenCallback,h=f&&l&&f[l]?f[l]:[t,l].join("/");void 0===h&&console.log("httpAgentFilter: Url is not defined");const g={params:r,debugInfo:a,filterParams:s,namedInputs:o,inputs:o};return p?await i(e,h,g,d,u):await(async(e,t,r)=>{const a={...r,"Content-Type":"application/json"},n=await fetch(e,{method:"post",headers:a,body:JSON.stringify(t)});return await n.json()})(h,g,d)}return t(e)},e.namedInputValidatorFilter=async(e,t)=>{const{inputSchema:r,namedInputs:a}=e,{agentId:n,nodeId:s}=e.debugInfo;return r&&"array"!==r.type&&o(r,a||{},s,n),t(e)},e.sortObjectKeys=c,Object.keys(t).forEach((function(r){"default"===r||Object.prototype.hasOwnProperty.call(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[r]}})})),Object.keys(r).forEach((function(t){"default"===t||Object.prototype.hasOwnProperty.call(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:function(){return r[t]}})}))}));
//# sourceMappingURL=bundle.umd.js.map
