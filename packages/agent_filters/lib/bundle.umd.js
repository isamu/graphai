!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("graphai"),require("ajv"),require("@noble/hashes/sha2"),require("@inquirer/input")):"function"==typeof define&&define.amd?define(["exports","graphai","ajv","@noble/hashes/sha2","@inquirer/input"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).graphai_agent_filters={},e.graphai,e.Ajv,e.sha2,e.input)}(this,(function(e,t,n,a,r){"use strict";const s=(e,t,a,r)=>{if(!(new n).compile(e)(t))throw new Error(`${a}(${r??"func"}) schema not matched`);return!0};const o=async(e,t,n,a,r)=>{const s=async function*(e,t,n){const{params:a,namedInputs:r,debugInfo:s,filterParams:o}=t,i={params:a,debugInfo:s,filterParams:o,namedInputs:r},c={...n,"Content-Type":"text/event-stream"},u=await fetch(e,{headers:c,method:"POST",body:JSON.stringify(i)}),d=u.body?.getReader();if(200!==u.status||!d)throw new Error("Request failed");const l=new TextDecoder("utf-8");let p=!1;for(;!p;){const{done:e,value:t}=await d.read();if(e)p=e,d.releaseLock();else{const e=l.decode(t,{stream:!0});yield e}}}(t,n,a),o=[];for await(const t of s)r&&console.log(t),t&&(o.push(t),-1===o.join("").indexOf("___END___")&&e.filterParams.streamTokenCallback&&e.filterParams.streamTokenCallback(t));const i=o.join("").split("___END___")[1];return JSON.parse(i)},i=e=>Array.isArray(e)?e.map((e=>i(e))):t.isObject(e)?Object.keys(e).sort().reduce(((t,n)=>(t[n]=e[n],t)),{}):e,c=e=>{const{namedInputs:t,params:n,debugInfo:r}=e,{agentId:s}=r,o=a.sha256(JSON.stringify(i({namedInputs:t,params:n,agentId:s})));return btoa(String.fromCharCode(...o))},u=e=>async(t,n)=>{const a=await n(t);return await e(t,a),a},d=u((async(e,t)=>{const{params:n,namedInputs:a,debugInfo:s}=e,{nodeId:o,agentId:i,retry:c,state:u}=s;console.log({nodeId:o,agentId:i,params:n,namedInputs:a,result:t,state:u,retry:c});await r({message:"Puress enter to next"})}));e.agentFilterRunnerBuilder=e=>{const t=e;return(e,n)=>{let a=0;const r=e=>{const s=t[a++];return s?s.agent(e,r):n(e)};return r(e)}},e.agentInputValidator=s,e.cacheAgentFilterGenerator=e=>{const{getCache:t,setCache:n,getCacheKey:a}=e;return async(e,r)=>{if("pureAgent"===e.cacheType||void 0===e.cacheType){const s=a?a(e):c(e),o=await t(s);if(o)return o;const i=await r(e);return await n(s,i),i}return"impureAgent"===e.cacheType&&(e.filterParams.cache={getCache:t,setCache:n,getCacheKey:c}),r(e)}},e.consoleStepRunner=d,e.httpAgentFilter=async(e,n)=>{const{params:a,debugInfo:r,filterParams:s,namedInputs:i,config:c}=e;if(s?.server){const{baseUrl:n,isDebug:u,serverAgentUrlDictionary:d}=s.server,l=c?.headers??{};if(!t.isObject(l))throw new Error("httpAgentFilter: headers is not object.");const p=r.agentId,f=void 0!==s.streamTokenCallback,g=d&&p&&d[p]?d[p]:[n,p].join("/");void 0===g&&console.log("httpAgentFilter: Url is not defined");const h={params:a,debugInfo:r,filterParams:s,namedInputs:i,inputs:i};return f?await o(e,g,h,l,u):await(async(e,t,n)=>{const a={...n,"Content-Type":"application/json"},r=await fetch(e,{method:"post",headers:a,body:JSON.stringify(t)});return await r.json()})(g,h,l)}return n(e)},e.namedInputValidatorFilter=async(e,t)=>{const{inputSchema:n,namedInputs:a}=e,{agentId:r,nodeId:o}=e.debugInfo;return n&&"array"!==n.type&&s(n,a||{},o,r),t(e)},e.sortObjectKeys=i,e.stepRunnerGenerator=u,e.streamAgentFilterGenerator=e=>async(n,a)=>(n.debugInfo.isResult&&(n.filterParams.streamTokenCallback=a=>{n.debugInfo.state===t.NodeState.Executing&&e(n,a)}),a(n))}));
//# sourceMappingURL=bundle.umd.js.map
