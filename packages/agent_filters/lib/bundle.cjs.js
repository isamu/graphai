"use strict";var e=require("graphai"),t=require("ajv"),r=require("@noble/hashes/sha2"),a=require("@inquirer/input");const n=(e,r,a,n)=>{if(!(new t).compile(e)(r))throw new Error(`${a}(${n??"func"}) schema not matched`);return!0};const s=async(e,t,r,a,n)=>{const s=async function*(e,t,r){const{params:a,namedInputs:n,debugInfo:s,filterParams:o}=t,i={params:a,debugInfo:s,filterParams:o,namedInputs:n},c={...r,"Content-Type":"text/event-stream"},u=await fetch(e,{headers:c,method:"POST",body:JSON.stringify(i)}),d=u.body?.getReader();if(200!==u.status||!d)throw new Error("Request failed");const p=new TextDecoder("utf-8");let l=!1;for(;!l;){const{done:e,value:t}=await d.read();if(e)l=e,d.releaseLock();else{const e=p.decode(t,{stream:!0});yield e}}}(t,r,a),o=[];for await(const t of s)n&&console.log(t),t&&(o.push(t),-1===o.join("").indexOf("___END___")&&e.filterParams.streamTokenCallback&&e.filterParams.streamTokenCallback(t));const i=o.join("").split("___END___")[1];return JSON.parse(i)},o=t=>Array.isArray(t)?t.map((e=>o(e))):e.isObject(t)?Object.keys(t).sort().reduce(((e,r)=>(e[r]=t[r],e)),{}):t,i=e=>{const{namedInputs:t,params:a,debugInfo:n}=e,{agentId:s}=n,i=r.sha256(JSON.stringify(o({namedInputs:t,params:a,agentId:s})));return btoa(String.fromCharCode(...i))},c=e=>async(t,r)=>{const a=await r(t);return await e(t,a),a},u=c((async(e,t)=>{const{params:r,namedInputs:n,debugInfo:s}=e,{nodeId:o,agentId:i,retry:c,state:u}=s;console.log({nodeId:o,agentId:i,params:r,namedInputs:n,result:t,state:u,retry:c});await a({message:"Puress enter to next"})}));exports.agentFilterRunnerBuilder=e=>{const t=e;return(e,r)=>{let a=0;const n=e=>{const s=t[a++];return s?s.agent(e,n):r(e)};return n(e)}},exports.agentInputValidator=n,exports.cacheAgentFilterGenerator=e=>{const{getCache:t,setCache:r,getCacheKey:a}=e;return async(e,n)=>{if("pureAgent"===e.cacheType||void 0===e.cacheType){const s=a?a(e):i(e),o=await t(s);if(o)return o;const c=await n(e);return await r(s,c),c}return"impureAgent"===e.cacheType&&(e.filterParams.cache={getCache:t,setCache:r,getCacheKey:i}),n(e)}},exports.consoleStepRunner=u,exports.httpAgentFilter=async(t,r)=>{const{params:a,debugInfo:n,filterParams:o,namedInputs:i,config:c}=t;if(o?.server){const{baseUrl:r,isDebug:u,serverAgentUrlDictionary:d}=o.server,p=c?.headers??{};if(!e.isObject(p))throw new Error("httpAgentFilter: headers is not object.");const l=n.agentId,g=void 0!==o.streamTokenCallback,m=d&&l&&d[l]?d[l]:[r,l].join("/");void 0===m&&console.log("httpAgentFilter: Url is not defined");const f={params:a,debugInfo:n,filterParams:o,namedInputs:i,inputs:i};return g?await s(t,m,f,p,u):await(async(e,t,r)=>{const a={...r,"Content-Type":"application/json"},n=await fetch(e,{method:"post",headers:a,body:JSON.stringify(t)});return await n.json()})(m,f,p)}return r(t)},exports.namedInputValidatorFilter=async(e,t)=>{const{inputSchema:r,namedInputs:a}=e,{agentId:s,nodeId:o}=e.debugInfo;return r&&"array"!==r.type&&n(r,a||{},o,s),t(e)},exports.sortObjectKeys=o,exports.stepRunnerGenerator=c,exports.streamAgentFilterGenerator=t=>async(r,a)=>(r.debugInfo.isResult&&(r.filterParams.streamTokenCallback=a=>{r.debugInfo.state===e.NodeState.Executing&&t(r,a)}),a(r));
//# sourceMappingURL=bundle.cjs.js.map
