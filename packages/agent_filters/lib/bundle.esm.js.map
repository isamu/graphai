{"version":3,"file":"bundle.esm.js","sources":["../src/filters/namedinput_validator.ts","../src/filters/http_client.ts","../src/filters/cache.ts","../src/utils/runner.ts"],"sourcesContent":["import { AgentFilterFunction } from \"graphai\";\nimport Ajv from \"ajv\";\n\n// export for test\nexport const agentInputValidator = (inputSchema: any, namedInputs: any, nodeId: string, agentId: string | undefined) => {\n  const ajv = new Ajv();\n  const validateSchema = ajv.compile(inputSchema);\n  if (!validateSchema(namedInputs)) {\n    // console.log(validateSchema.errors);\n    throw new Error(`${nodeId}(${agentId ?? \"func\"}) schema not matched`);\n  }\n  return true;\n};\n\nexport const namedInputValidatorFilter: AgentFilterFunction = async (context, next) => {\n  const { inputSchema, namedInputs } = context;\n  const { agentId, nodeId } = context.debugInfo;\n\n  if (inputSchema) {\n    if (inputSchema.type !== \"array\") {\n      agentInputValidator(inputSchema, namedInputs || {}, nodeId, agentId);\n    }\n  }\n\n  return next(context);\n};\n","import { AgentFilterFunction, AgentFunctionContext, isObject } from \"graphai\";\n\nasync function* streamChatCompletion(url: string, postData: AgentFunctionContext, userHeaders: any) {\n  const { params, namedInputs, debugInfo, filterParams } = postData;\n  const postBody = { params, debugInfo, filterParams, namedInputs };\n  const headers = { ...userHeaders, \"Content-Type\": \"text/event-stream\" };\n\n  const completion = await fetch(url, {\n    headers,\n    method: \"POST\",\n    body: JSON.stringify(postBody),\n  });\n\n  const reader = completion.body?.getReader();\n\n  if (completion.status !== 200 || !reader) {\n    throw new Error(\"Request failed\");\n  }\n\n  const decoder = new TextDecoder(\"utf-8\");\n  let done = false;\n  while (!done) {\n    const { done: readDone, value } = await reader.read();\n    if (readDone) {\n      done = readDone;\n      reader.releaseLock();\n    } else {\n      const token = decoder.decode(value, { stream: true });\n      yield token;\n    }\n  }\n}\n\nconst streamingRequest = async (context: AgentFunctionContext, url: string, postData: AgentFunctionContext, userHeaders: any, isDebug: boolean | undefined) => {\n  const generator = streamChatCompletion(url, postData, userHeaders);\n\n  const messages = [];\n  for await (const token of generator) {\n    if (isDebug) {\n      console.log(token);\n    }\n    // callback to stream filter\n    if (token) {\n      messages.push(token);\n      if (messages.join(\"\").indexOf(\"___END___\") === -1 && context.filterParams.streamTokenCallback) {\n        context.filterParams.streamTokenCallback(token);\n      }\n    }\n  }\n\n  const payload_data = messages.join(\"\").split(\"___END___\")[1];\n  const data = JSON.parse(payload_data);\n  return data;\n};\nconst httpRequest = async (url: string, postData: AgentFunctionContext, userHeaders: any) => {\n  const headers = { ...userHeaders, \"Content-Type\": \"application/json\" };\n  const response = await fetch(url, {\n    method: \"post\",\n    headers,\n    body: JSON.stringify(postData),\n  });\n  return await response.json();\n};\n\nexport const httpAgentFilter: AgentFilterFunction = async (context, next) => {\n  const { params, debugInfo, filterParams, namedInputs, config } = context;\n\n  if (filterParams?.server) {\n    const { baseUrl, isDebug, serverAgentUrlDictionary } = filterParams.server;\n    const headers = config?.headers ?? {};\n    if (!isObject(headers)) {\n      throw new Error(\"httpAgentFilter: headers is not object.\");\n    }\n    const agentId = debugInfo.agentId;\n    const isStreaming = filterParams.streamTokenCallback !== undefined;\n    const url = serverAgentUrlDictionary && agentId && serverAgentUrlDictionary[agentId] ? serverAgentUrlDictionary[agentId] : [baseUrl, agentId].join(\"/\");\n    if (url === undefined) {\n      console.log(\"httpAgentFilter: Url is not defined\");\n    }\n    const postData = {\n      params,\n      debugInfo,\n      filterParams,\n      namedInputs,\n      inputs: namedInputs, // alias.\n    };\n    if (isStreaming) {\n      return await streamingRequest(context, url, postData, headers, isDebug);\n    }\n    return await httpRequest(url, postData, headers);\n  }\n  return next(context);\n};\n","import { AgentFilterFunction, AgentFunctionContext, isObject } from \"graphai\";\nimport { sha256 } from \"@noble/hashes/sha2\";\n\ntype CacheAgentFilterSetCache = (key: string, data: any) => Promise<void>;\ntype CacheAgentFilterGetCache = (key: string) => Promise<any>;\ntype CacheAgentFilterGetCacheKey = (context: AgentFunctionContext) => string;\n\n// for cache key, sort object key\nexport const sortObjectKeys = (data: any[] | Record<string, any> | string | number | boolean): any => {\n  if (Array.isArray(data)) {\n    return data.map((d) => sortObjectKeys(d));\n  }\n  if (isObject(data)) {\n    return Object.keys(data)\n      .sort()\n      .reduce((tmp: Record<string, any>, key: string) => {\n        tmp[key] = data[key];\n        return tmp;\n      }, {});\n  }\n  return data;\n};\n\nconst getDefaultCacheKey = (context: AgentFunctionContext) => {\n  const { namedInputs, params, debugInfo } = context;\n  const { agentId } = debugInfo;\n  const cacheKeySeed = sha256(JSON.stringify(sortObjectKeys({ namedInputs, params, agentId })));\n  const cacheKey = btoa(String.fromCharCode(...cacheKeySeed));\n  return cacheKey;\n};\n\n// There are two types of cache\n//  - pureAgent whose results are always the same for each input\n//  - impureAgent with different results for the same inputs. For example, reading a file.\n// pureAgent performs caching within agent filter. impureAgent with different results for the same inputs. For example, reading a file.\n// impureAgent implements a cache mechanism on the agent side.\n// Actual cache reading/writing function is given to cacheAgentFilterGenerator\n\nexport const cacheAgentFilterGenerator = (cacheRepository: {\n  setCache: CacheAgentFilterSetCache;\n  getCache: CacheAgentFilterGetCache;\n  getCacheKey?: CacheAgentFilterGetCacheKey;\n}) => {\n  const { getCache, setCache, getCacheKey } = cacheRepository;\n  const cacheAgentFilter: AgentFilterFunction = async (context, next) => {\n    if (context.cacheType === \"pureAgent\" || context.cacheType === undefined) {\n      const cacheKey = getCacheKey ? getCacheKey(context) : getDefaultCacheKey(context);\n      const cache = await getCache(cacheKey);\n      if (cache) {\n        return cache;\n      }\n      const result = await next(context);\n      await setCache(cacheKey, result);\n      return result;\n    }\n\n    if (context.cacheType === \"impureAgent\") {\n      context.filterParams.cache = {\n        getCache,\n        setCache,\n        getCacheKey: getDefaultCacheKey,\n      };\n    }\n    return next(context);\n  };\n  return cacheAgentFilter;\n};\n","import { AgentFunctionContext, AgentFunction, AgentFilterInfo, ResultData } from \"graphai\";\n\n// for test and server.\nexport const agentFilterRunnerBuilder = (__agentFilters: AgentFilterInfo[]) => {\n  const agentFilters = __agentFilters;\n  const agentFilterRunner = (context: AgentFunctionContext, agent: AgentFunction) => {\n    let index = 0;\n\n    const next = (context: AgentFunctionContext): Promise<ResultData> => {\n      const agentFilter = agentFilters[index++];\n      if (agentFilter) {\n        return agentFilter.agent(context, next);\n      }\n      return agent(context);\n    };\n\n    return next(context);\n  };\n  return agentFilterRunner;\n};\n"],"names":[],"mappings":"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"}